FROM strapi/base

RUN npm i -g strapi

WORKDIR $DIRPATH/$DIRNAME

COPY . .

RUN yarn install
RUN chmod +x /wait-for-it.sh

EXPOSE 1337

ARG POSTGRES_HOST=undefined
ENV POSTGRES_HOST=$POSTGRES_HOST
ARG POSTGRES_EXTERNAL_PORT=undefined
ENV POSTGRES_EXTERNAL_PORT=$POSTGRES_EXTERNAL_PORT
ARG POSTGRES_USER=undefined
ENV POSTGRES_USER=$POSTGRES_USER
ARG POSTGRES_DB=undefined
ENV POSTGRES_DB=$POSTGRES_DB

ENV NODE_ENV production
ENTRYPOINT [ "sh", "-c", "./wait-for-it.sh -t 30 $POSTGRES_HOST:$POSTGRES_EXTERNAL_PORT -- yarn start:docker:prod" ]